---
interface Props {
  slug: string;
}

const { slug } = Astro.props;
---

<div
  class="inline-flex items-center gap-2 text-gray-600 dark:text-gray-400 text-sm"
  data-slug={slug}
>
  <svg
    class="fill-transparent w-5 h-5"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
  >
    <path
      d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"
    ></path>
    <circle cx="12" cy="12" r="3"></circle>
  </svg>
  <span class="views-count font-semibold">・・・</span>
  <span>次瀏覽</span>
</div>

<script is:inline define:vars={{ slug }}>
  (function () {
    async function updatePageViews() {
      const currentSlug = slug;

      if (!currentSlug) {
        console.error("No slug provided");
        return;
      }

      try {
        const response = await fetch("/.netlify/functions/page-views", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ slug: currentSlug, action: "increment" }),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        const countElement = document.querySelector(".views-count");
        if (countElement && data.views !== undefined) {
          countElement.textContent = data.views.toLocaleString("zh-TW");
        }
      } catch (error) {
        console.error("Failed to update page views:", error);
        const countElement = document.querySelector(".views-count");
        if (countElement) {
          countElement.textContent = "--";
        }
      }
    }

    // 確保 DOM 已載入
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", updatePageViews);
    } else {
      updatePageViews();
    }
  })();
</script>